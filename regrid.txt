#REGRID
import xarray as xr
import numpy as np
import os

input_folder = r"D:\tes\SST_output"
output_folder = r"D:\tes\SST_output\tes"

for root, dirs, files in os.walk(input_folder):
    for filename in files:
        if filename.endswith(".nc"):
            file_path = os.path.join(root, filename)
            print(f"Processing {file_path}...")

            try:
                # Buka dan hilangkan 29 Februari
                ds = xr.open_dataset(file_path)
                ds = ds.sel(time=~((ds.time.dt.month == 2) & (ds.time.dt.day == 29)))

                # Ambil rentang lat/lon
                lat_min = float(ds.latitude.min())
                lat_max = float(ds.latitude.max())
                lon_min = float(ds.longitude.min())
                lon_max = float(ds.longitude.max())

                # Buat grid target
                target_lat = np.arange(lat_min, lat_max + 0.125, 0.125)
                target_lon = np.arange(lon_min, lon_max + 0.125, 0.125)

                # Interpolasi
                regridded_ds = ds.interp(latitude=target_lat, longitude=target_lon, method='linear')

                # Buat path output yang mencerminkan struktur folder input
                relative_path = os.path.relpath(root, input_folder)
                output_subfolder = os.path.join(output_folder, relative_path)
                os.makedirs(output_subfolder, exist_ok=True)

                output_path = os.path.join(output_subfolder, f"regrid_{filename}")
                regridded_ds.to_netcdf(output_path)
                print(f"✓ Regridding selesai: {output_path}")

            except Exception as e:
                print(f"✗ Gagal memproses {file_path}: {e}")

print("✅ Proses regridding selesai untuk semua file.")
